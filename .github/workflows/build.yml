name: Build & Release Setup.exe

on:
  push:
    tags:
      - 'v*' # Starts only when you push a tag like v1.0.0
  workflow_dispatch: # Allows manual start for testing

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write # IMPORTANT: Allows creating releases

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller auto-py-to-exe customtkinter packaging paho-mqtt Pillow requests pdf2image

    # ROBUST Poppler Download
    - name: Download Poppler
      shell: powershell
      run: |
        $url = "https://github.com/oschwartz10612/poppler-windows/releases/download/v24.02.0-0/Release-24.02.0-0.zip"
        $output = "poppler.zip"
        
        Write-Host "Downloading Poppler..."
        Invoke-WebRequest -Uri $url -OutFile $output
        
        Write-Host "Extracting..."
        Expand-Archive -Path $output -DestinationPath "poppler_extracted"
        
        # Finds the 'Library' folder, regardless of where it is in the zip (safer)
        $libPath = Get-ChildItem -Path "poppler_extracted" -Recurse -Directory -Filter "Library" | Select-Object -First 1
        
        if ($libPath) {
            Move-Item -Path $libPath.FullName -Destination "poppler"
            Write-Host "Poppler successfully moved to root."
        } else {
            Write-Error "Library folder not found inside zip!"
            exit 1
        }

    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --noconsole --onefile --name "TicketPrinter" --icon "assets/Thermal-Printer.ico" --collect-all customtkinter universal_ticket_printer.py

    - name: Install Inno Setup
      run: choco install innosetup --no-progress

    # Encoding Fix for Umlaute and English translation
    - name: Generate Inno Setup Script
      shell: powershell
      run: |
        $version = "${{ github.ref_name }}" -replace "v",""
        if ($version -eq "main") { $version = "1.0.0" } 
        
        $issContent = @"
        [Setup]
        AppName=Universal Ticket Printer
        AppVersion=$version
        DefaultDirName={autopf}\TicketPrinter
        DefaultGroupName=TicketPrinter
        OutputBaseFilename=TicketPrinter_Setup
        Compression=lzma
        SolidCompression=yes
        ArchitecturesInstallIn64BitMode=x64
        OutputDir=Output

        [Tasks]
        Name: "desktopicon"; Description: "Create a desktop icon"; GroupDescription: "Additional icons:"; Flags: unchecked

        [Files]
        Source: "dist\TicketPrinter.exe"; DestDir: "{app}"; Flags: ignoreversion
        Source: "poppler\*"; DestDir: "{app}\poppler"; Flags: ignoreversion recursesubdirs createallsubdirs
        Source: "assets\*"; DestDir: "{app}\assets"; Flags: ignoreversion recursesubdirs createallsubdirs

        [Icons]
        Name: "{group}\Ticket Printer"; Filename: "{app}\TicketPrinter.exe"; IconFilename: "{app}\assets\Thermal-Printer.ico"
        Name: "{autodesktop}\Ticket Printer"; Filename: "{app}\TicketPrinter.exe"; IconFilename: "{app}\assets\Thermal-Printer.ico"; Tasks: desktopicon

        [Run]
        Filename: "{app}\TicketPrinter.exe"; Description: "Launch program"; Flags: nowait postinstall skipifsilent
        "@
        
        # Writes the file explicitly as UTF8 with BOM for Inno Setup
        [System.IO.File]::WriteAllLines("$(Get-Location)\setup_script.iss", $issContent, [System.Text.Encoding]::UTF8)

    - name: Compile Installer
      run: '& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup_script.iss'

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: Output/TicketPrinter_Setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}