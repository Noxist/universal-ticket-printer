name: Build & Release Setup.exe

on:
  push:
    tags:
      - 'v*' # Startet nur, wenn du einen Tag wie v1.0.0 pushst
  workflow_dispatch: # Erlaubt manuellen Start zum Testen

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write # WICHTIG: Erlaubt das Erstellen von Releases

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller auto-py-to-exe customtkinter packaging paho-mqtt Pillow requests pdf2image

    # NEU: Poppler herunterladen und bereitstellen
    - name: Download and Setup Poppler
      shell: powershell
      run: |
        # Neueste stabile Poppler Version für Windows herunterladen (angepasst an aktuellen Release)
        $url = "https://github.com/oschwartz10612/poppler-windows/releases/download/v24.02.0-0/Release-24.02.0-0.zip"
        $output = "poppler.zip"
        
        Write-Host "Downloading Poppler from $url..."
        Invoke-WebRequest -Uri $url -OutFile $output
        
        Write-Host "Extracting Poppler..."
        Expand-Archive -Path $output -DestinationPath "poppler_temp"
        
        # Verschiebe den Library-Ordner (enthält bin, lib, include) nach 'poppler' im Root
        # Die Struktur im Zip ist meist Release-X.X.X-0/Library
        $extractedRoot = Get-ChildItem -Path "poppler_temp" | Select-Object -First 1
        $libraryPath = Join-Path $extractedRoot.FullName "Library"
        
        if (Test-Path $libraryPath) {
            Move-Item -Path $libraryPath -Destination "poppler"
            Write-Host "Poppler setup complete."
        } else {
            Write-Error "Could not find Library folder in extracted poppler archive."
            exit 1
        }

    # 1. Programm zur EXE kompilieren
    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --noconsole --onefile --name "TicketPrinter" --icon "assets/Thermal-Printer.ico" --collect-all customtkinter universal_ticket_printer.py

    # 2. Inno Setup installieren
    - name: Install Inno Setup
      run: choco install innosetup --no-progress

    # 3. Installer-Skript erstellen
    # FIX: Encoding auf UTF8 gesetzt, damit Umlaute (ä, ö, ü) im Installer korrekt sind
    - name: Generate Inno Setup Script
      shell: powershell
      run: |
        $version = "${{ github.ref_name }}" -replace "v",""
        if ($version -eq "main") { $version = "1.0.0" } 
        
        $issContent = @"
        [Setup]
        AppName=Universal Ticket Printer
        AppVersion=$version
        DefaultDirName={autopf}\TicketPrinter
        DefaultGroupName=TicketPrinter
        OutputBaseFilename=TicketPrinter_Setup
        Compression=lzma
        SolidCompression=yes
        ArchitecturesInstallIn64BitMode=x64
        OutputDir=Output

        [Tasks]
        Name: "desktopicon"; Description: "Erstelle ein Desktop-Icon"; GroupDescription: "Zusätzliche Icons:"; Flags: unchecked

        [Files]
        Source: "dist\TicketPrinter.exe"; DestDir: "{app}"; Flags: ignoreversion
        Source: "poppler\*"; DestDir: "{app}\poppler"; Flags: ignoreversion recursesubdirs createallsubdirs
        Source: "assets\*"; DestDir: "{app}\assets"; Flags: ignoreversion recursesubdirs createallsubdirs

        [Icons]
        Name: "{group}\Ticket Printer"; Filename: "{app}\TicketPrinter.exe"; IconFilename: "{app}\assets\Thermal-Printer.ico"
        Name: "{autodesktop}\Ticket Printer"; Filename: "{app}\TicketPrinter.exe"; IconFilename: "{app}\assets\Thermal-Printer.ico"; Tasks: desktopicon

        [Run]
        Filename: "{app}\TicketPrinter.exe"; Description: "Programm starten"; Flags: nowait postinstall skipifsilent
        "@
        
        # WICHTIG: UTF8 Encoding für korrekte Umlaute im Wizard
        $issContent | Out-File "setup_script.iss" -Encoding UTF8

    # 4. Installer bauen
    - name: Compile Installer
      run: '& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup_script.iss'

    # 5. Release erstellen und Datei hochladen (NUR bei Tags)
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: Output/TicketPrinter_Setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}