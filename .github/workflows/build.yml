name: Build & Release Setup.exe

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*' # Starts only when you push a tag like v1.0.0
  workflow_dispatch: # Allows manual start for testing

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write # IMPORTANT: Allows creating releases

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller auto-py-to-exe customtkinter packaging paho-mqtt Pillow requests pdf2image

    - name: Set build variables
      shell: powershell
      run: |
        $refType = "${{ github.ref_type }}"
        $refName = "${{ github.ref_name }}"
        $safeRef = $refName -replace '[^A-Za-z0-9._-]', '-'
        if ($refType -eq "tag") {
          $outputName = "TicketPrinter_Setup"
          $appVersion = $refName -replace "^v",""
          $channel = "release"
        } else {
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          $outputName = "TicketPrinter_Preview_$safeRef"
          $appVersion = "0.0.0-preview-$shortSha"
          $channel = "preview"
        }
        "OUTPUT_NAME=$outputName" >> $env:GITHUB_ENV
        "APP_VERSION=$appVersion" >> $env:GITHUB_ENV
        "BUILD_CHANNEL=$channel" >> $env:GITHUB_ENV
        "SAFE_REF=$safeRef" >> $env:GITHUB_ENV

    # ROBUST Poppler Download
    - name: Download Poppler
      shell: powershell
      run: |
        $url = "https://github.com/oschwartz10612/poppler-windows/releases/download/v24.02.0-0/Release-24.02.0-0.zip"
        $output = "poppler.zip"
        
        Write-Host "Downloading Poppler..."
        Invoke-WebRequest -Uri $url -OutFile $output
        
        Write-Host "Extracting..."
        Expand-Archive -Path $output -DestinationPath "poppler_extracted"
        
        # Finds the 'Library' folder, regardless of where it is in the zip (safer)
        $libPath = Get-ChildItem -Path "poppler_extracted" -Recurse -Directory -Filter "Library" | Select-Object -First 1
        
        if ($libPath) {
            Move-Item -Path $libPath.FullName -Destination "poppler"
            Write-Host "Poppler successfully moved to root."
        } else {
            Write-Error "Library folder not found inside zip!"
            exit 1
        }

    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --noconsole --onefile --name "TicketPrinter" --icon "assets/Thermal-Printer.ico" --collect-all customtkinter universal_ticket_printer.py

    - name: Install Inno Setup
      run: choco install innosetup --no-progress

    # Encoding Fix for Umlaute and English translation
    - name: Generate Inno Setup Script
      shell: powershell
      run: |
        $issContent = @"
        [Setup]
        AppName=Universal Ticket Printer
        AppVersion=$env:APP_VERSION
        DefaultDirName={autopf}\TicketPrinter
        DefaultGroupName=TicketPrinter
        OutputBaseFilename=$env:OUTPUT_NAME
        Compression=lzma
        SolidCompression=yes
        ArchitecturesInstallIn64BitMode=x64
        OutputDir=Output

        [Tasks]
        Name: "desktopicon"; Description: "Create a desktop icon"; GroupDescription: "Additional icons:"; Flags: unchecked
        Name: "miktex"; Description: "Open MiKTeX download page"; GroupDescription: "Additional tools:"; Flags: unchecked

        [Files]
        Source: "dist\TicketPrinter.exe"; DestDir: "{app}"; Flags: ignoreversion
        Source: "poppler\*"; DestDir: "{app}\poppler"; Flags: ignoreversion recursesubdirs createallsubdirs
        Source: "assets\*"; DestDir: "{app}\assets"; Flags: ignoreversion recursesubdirs createallsubdirs

        [Icons]
        Name: "{group}\Ticket Printer"; Filename: "{app}\TicketPrinter.exe"; IconFilename: "{app}\assets\Thermal-Printer.ico"
        Name: "{autodesktop}\Ticket Printer"; Filename: "{app}\TicketPrinter.exe"; IconFilename: "{app}\assets\Thermal-Printer.ico"; Tasks: desktopicon

        [Run]
        Filename: "{app}\TicketPrinter.exe"; Description: "Launch program"; Flags: nowait postinstall skipifsilent
        Filename: "https://miktex.org/download"; Description: "Get MiKTeX (LaTeX support)"; Flags: shellexec postinstall skipifsilent unchecked; Tasks: miktex
        "@
        
        # Writes the file explicitly as UTF8 with BOM for Inno Setup
        [System.IO.File]::WriteAllLines("$(Get-Location)\setup_script.iss", $issContent, [System.Text.Encoding]::UTF8)

    - name: Compile Installer
      run: '& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup_script.iss'

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: Output/TicketPrinter_Setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload preview artifact
      uses: actions/upload-artifact@v4
      if: env.BUILD_CHANNEL == 'preview'
      with:
        name: ${{ env.OUTPUT_NAME }}
        path: Output/${{ env.OUTPUT_NAME }}.exe
