name: Build & Release Setup.exe

on:
  push:
    tags:
      - 'v*' # Startet nur, wenn du einen Tag wie v1.0.0 pushst
  workflow_dispatch: # Erlaubt manuellen Start zum Testen

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write # WICHTIG: Erlaubt das Erstellen von Releases

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller auto-py-to-exe customtkinter packaging paho-mqtt Pillow requests pdf2image

    # 1. Programm zur EXE kompilieren
    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --noconsole --onefile --name "TicketPrinter" --icon "assets/Thermal-Printer.ico" --collect-all customtkinter universal_ticket_printer.py

    # 2. Inno Setup installieren
    - name: Install Inno Setup
      run: choco install innosetup --no-progress

    # 3. Installer-Skript erstellen
    - name: Generate Inno Setup Script
      shell: powershell
      run: |
        $version = "${{ github.ref_name }}" -replace "v",""
        if ($version -eq "main") { $version = "1.0.0" } 
        
        $issContent = @"
        [Setup]
        AppName=Universal Ticket Printer
        AppVersion=$version
        DefaultDirName={autopf}\TicketPrinter
        DefaultGroupName=TicketPrinter
        OutputBaseFilename=TicketPrinter_Setup
        Compression=lzma
        SolidCompression=yes
        ArchitecturesInstallIn64BitMode=x64
        OutputDir=Output

        [Tasks]
        Name: "desktopicon"; Description: "Erstelle ein Desktop-Icon"; GroupDescription: "Zus√§tzliche Icons:"; Flags: unchecked

        [Files]
        Source: "dist\TicketPrinter.exe"; DestDir: "{app}"; Flags: ignoreversion
        Source: "poppler\*"; DestDir: "{app}\poppler"; Flags: ignoreversion recursesubdirs createallsubdirs
        Source: "assets\*"; DestDir: "{app}\assets"; Flags: ignoreversion recursesubdirs createallsubdirs

        [Icons]
        Name: "{group}\Ticket Printer"; Filename: "{app}\TicketPrinter.exe"; IconFilename: "{app}\assets\Thermal-Printer.ico"
        Name: "{autodesktop}\Ticket Printer"; Filename: "{app}\TicketPrinter.exe"; IconFilename: "{app}\assets\Thermal-Printer.ico"; Tasks: desktopicon

        [Run]
        Filename: "{app}\TicketPrinter.exe"; Description: "Programm starten"; Flags: nowait postinstall skipifsilent
        "@
        
        $issContent | Out-File "setup_script.iss" -Encoding ASCII

    # 4. Installer bauen
    - name: Compile Installer
      run: '& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup_script.iss'

    # 5. Release erstellen und Datei hochladen (NUR bei Tags)
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: Output/TicketPrinter_Setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}